<!DOCTYPE html>
<html>
<head>
<title>Receipt Verification</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background: #f4f6f9;
}
.card {
  border-radius: 18px;
}
.btn-primary {
  background-color: #198754;
  border: none;
}
.btn-primary:hover {
  background-color: #157347;
}
.logo-title {
  font-weight: 600;
}
</style>
</head>

<body>

<div class="container mt-5">
<div class="card shadow mx-auto" style="max-width:500px;">
<div class="card-header bg-dark text-white text-center">
<h5 class="mb-0 logo-title">Donation Receipt Verification</h5>
</div>

<div class="card-body">

<div id="errorMsg" class="alert alert-danger d-none"></div>
<div id="successMsg" class="alert alert-success d-none"></div>

<div class="mb-3">
<label class="form-label">Receipt Number</label>
<input type="text" id="receipt_no" class="form-control"
placeholder="Enter Receipt Number">
</div>

<div class="mb-3">
<label class="form-label">Mobile Number</label>
<input type="text" id="mobile" class="form-control"
placeholder="Enter 10 Digit Mobile">
</div>

<button class="btn btn-primary w-100" onclick="verifyReceipt()">
Verify Receipt
</button>

<div id="generateSection" class="mt-4 d-none">

<a id="downloadBtn" class="btn btn-success w-100 mb-2" target="_blank">
Download PDF Receipt
</a>

<button id="printBtn" class="btn btn-outline-dark w-100">
Print Receipt
</button>

</div>

</div>
</div>

<div class="text-center mt-3 text-muted small">
This is a public verification portal.  
Please enter correct receipt number and registered mobile.
</div>

</div>

<script>

/*
=========================================
VERIFY RECEIPT
=========================================
*/
function verifyReceipt(){

  const receipt = document.getElementById("receipt_no").value.trim();
  const mobile = document.getElementById("mobile").value.trim();

  if(!receipt || !mobile){
    showError("Please enter both Receipt Number and Mobile.");
    return;
  }

  if(!/^[0-9]{10}$/.test(mobile)){
    showError("Mobile number must be 10 digits.");
    return;
  }

  fetch(`/receipt-validate?receipt=${receipt}&mobile=${mobile}`)
  .then(res=>res.json())
  .then(data=>{

    if(data.valid){

      document.getElementById("generateSection").classList.remove("d-none");
      document.getElementById("downloadBtn").href =
        `/receipt-pdf/${receipt}/${mobile}`;

      document.getElementById("successMsg").innerText =
        "Receipt verified successfully.";
      document.getElementById("successMsg").classList.remove("d-none");

      document.getElementById("errorMsg").classList.add("d-none");

    } else {

      showError("Invalid Receipt Number or Mobile Number.");
      document.getElementById("generateSection").classList.add("d-none");

    }

  })
  .catch(()=>{
    showError("Error verifying receipt.");
  });
}

/*
=========================================
ERROR HANDLER
=========================================
*/
function showError(msg){
  document.getElementById("errorMsg").innerText = msg;
  document.getElementById("errorMsg").classList.remove("d-none");
  document.getElementById("successMsg").classList.add("d-none");
}

/*
=========================================
AUTO VERIFY (FOR CENTER ADMIN FLOW)
=========================================
*/
const params = new URLSearchParams(window.location.search);

const receiptParam = params.get("receipt");
const mobileParam = params.get("mobile");
const auto = params.get("auto");

if(receiptParam && mobileParam){

  document.getElementById("receipt_no").value = receiptParam;
  document.getElementById("mobile").value = mobileParam;

  if(auto === "true"){
    setTimeout(()=>{ verifyReceipt(); }, 400);
  }
}

/*
=========================================
PRINT
=========================================
*/
document.getElementById("printBtn").addEventListener("click", function(){
  const receipt = document.getElementById("receipt_no").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  window.open(`/receipt-pdf/${receipt}/${mobile}`, "_blank");
});

</script>

</body>
</html>
